<html lang="en"><head>
    <title>Red Neuronal números escritos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js">
      // Your code will go here
      // open up your console - if everything loaded properly you should see the correct version number
      console.log('ml5 version:', tf.version);
    </script>
  </head>

  <body style="background: gray">
    <h1>X</h1>
    <canvas width="250" height="250" style= "background: white">
    </canvas>
    <script>
//       modelo = await tf.loadLayersModel("./Modelo_pre_entrenado/model.json")
//       por el AWAIT
      try{tf.loadLayersModel("localstorage://modelo_entrenado_MNIST_web").then((respuesta) => {modelo=respuesta})}
      catch{tf.loadLayersModel("./Modelo_pre_entrenado/model.json").then((respuesta) => {modelo=respuesta})};
      var canvas = document.querySelector("canvas");
      var signaturePad = new SignaturePad(canvas, {maxWidth:8, minWidth:7, velocityFilterWeight: 0});
      document.querySelector("body > h1").textContent = Math.floor(Math.random()*10);
//       fun = function()
//       {
//         var canvas_data = canvas.getContext("2d").getImageData(0,0,canvas.height,canvas.width).data;
//         canvas_data_array = new Array(canvas_data.length/4);
//         for (i=0; i < canvas_data.length;i+=4)
//         {
//           //console.log("pixel " + (i/4+1) + "   [R]:"+canvas_data[i] + "   [G]:"+canvas_data[i+1] + "   [B]:"+canvas_data[i+2] + "   [L]:"+canvas_data[i+3]);
//           canvas_data_array[i/4] = canvas_data[i+3];
//         }
//         var renglon ="~";
//         for (i=0;i<canvas.height;i++)
//         {
//           for(j=0;j<canvas.width;j++)
//           {
//             if(canvas_data_array[i*canvas.width+j])
//             {
//               renglon += "+";
//             } else {
//               renglon += " ";
//             }
//           }
//           console.log(renglon+"\n");
//           renglon = "i";
//         }
//       }
    </script>
    <script>
      cargarValor = function () 
      {
        try { canvas2} catch{ canvas2 = document.createElement("canvas")};
        canvas2.width = 28;
        canvas2.height = 28;
        canvas2.style.background = "white";
        document.body.appendChild(canvas2);
        canvas2_cont = canvas2.getContext("2d");
        canvas2_cont.drawImage(canvas, 0,0, 28,28);
        canvas2_data = canvas2_cont.getImageData(0,0,canvas2.width, canvas2.height).data
        canvas2_data_array = new Array(canvas2_data.length/4);
        for (i=0; i < canvas2_data.length;i+=4)
        {
          canvas2_data_array[i/4] = canvas2_data[i+3];
        }
        try { historial, historial_numero } catch{ historial = new Array; historial_numero = new Array}
        historial.push(canvas2_data_array);
        historial_numero.push(document.querySelector("body > h1").textContent);
        document.querySelector("body > h1").textContent = Math.floor(Math.random()*10);
        canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
      }
      
      entrenarModelo = async function()
      {
        modelo.compile({loss:'categoricalCrossentropy', optimizer:'sgd', metrics:'accuracy'})
        ff = await modelo.fit(tf.tensor(historial,[historial.length,784]), tf.oneHot(historial_numero,10), {epochs:100, verbose:2})
        alert("entrenado");
        evaluacion = await modelo.fit(tf.tensor(historial,[historial.length,784]), tf.oneHot(historial_numero,10), {epochs:100})
        alert("evaluación => " + await evaluacion[1].array()*100 + "%");
        save_local = await modelo.save('localstorage://modelo_entrenado_MNIST_web')
      }
      descargarModelo() = ascync function()
      {
        save_file = await modelo.save('downloads://modelo_entrenado_MNIST_web')
      }
      
      cargardesdeArchivo = scync function()
      {
        const uploadJSONInput = document.getElementById('upload-json');
        const uploadWeightsInput = document.getElementById('upload-weights');
        modelo = await tf.loadLayersModel(tf.io.browserFiles(
        [uploadJSONInput.files[0], uploadWeightsInput.files[0]]));
      }
    </script>

    <button onclick="cargarValor()" style="width: 86px; height: 76px;">Cargar valor</button><b>  </b>
    <button onclick="signaturePad.clear()">Clear</button>
    <br><br>
    <div>
    <button onclick="entrenarModelo()" style="width: 86px; height: 76px;">Entrenar Modelo</button>
    <button onclick="descargarModelo()" style="width: 86px; height: 76px;">Descargar Modelo</button>
    </div>
    <br><br>
    <label for="upload-json">JSON file:</label>
    <input type="file" id="upload-json" name="upload-json"><br>
    <label for="upload-weights">BIN file:</label>
    <input type="file" id="upload-weights" name="upload-weights"><br>
    <button onclick="cargardesdeArchivo()">Cargar modelo desde archivo</button>
  </body>
  
